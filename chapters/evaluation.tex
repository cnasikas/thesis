%!TEX root = ../thesis.tex
\chapter{Evaluation}
\label{evaluation}

Saving data on the blockchain is expensive. Thus, various experiments have been made regarding the cost of saving data on the blockchain to compare and analyze various methods and alternatives.

All measurements were take in a MacBook Pro 2016 and in a local Ethereum testnet.

PC Specifications:

\begin{enumerate}
  \item CPU: 2GHz Intel Core i5 (2 cores)
  \item Memory: 8GB 1867 MHz LPDDR3
  \item 256GB PCI-Express SSD
\end{enumerate}

Ethereum Testnet Specifications:

\begin{enumerate}
  \item Ganache CLI v6.0.3 (ganache-core: 2.0.2)
  \item Solidity 0.4.19
\end{enumerate}

\section{Computation Costs}
\label{evaluation:computation_costs}

Ethreuem use a unit called gas as a measurement of computation use--an internal pricing mechanism used to execute contracts and allocate resources on the network-- and it's price is expressed in ether (Ethereum currency). Every node in the Ethereum network executes instructions (opcodes) within the Ethereum Virtual Machine (EVM) (ยง~\ref{blockchain:impl:ethereum}) and each of these instructions has an associated cost in gas. The cumulative sum of all the operations is the total gas cost for a transaction and is the fee that is being paid to the miners.

The cost of each opcode (operation code) of EVM is defined on Ethereum's yellow paper~\cite{ethereum_yellowpaper} and a gas cost summarization of basic opcodes are be shown on Table~\ref{table:opcode_gas_cost}.

For storing data, Ethereum offers two opcodes: SLOAD opcode loads a word from storage and SSTORE opcode saves a word to storage. The size of an EVM word is 32 bytes (256 bit) and to store one EVM word using SSTORE opcode costs 20.000 gas.

\begin{table}[!hb]
\centering
\begin{tabular}{|l|l|l|}
\hline
 Operation & Gas  & Description \\ \hline
 ADD/SUB & 3 & Arithmetic operation \\ \hline
 MUL/DIV & 5 & Arithmetic operation \\ \hline
 ADDMOD/MULMOD & 8 & Arithmetic operation \\ \hline
 AND/OR/XOR & 3 & Bitwise logic operation \\ \hline
 LT/GT/SLT/SGT/EQ & 3 & Comparison operation \\ \hline
 POP & 2 & Stack operation \\ \hline
 PUSH/DUP/SWAP & 3 & Stack operation \\ \hline
 MLOAD/MSTORE & 3 & Memory operation \\ \hline
 JUMP & 8 & Unconditional jump \\ \hline
 JUMPI & 10 & Conditional jump \\ \hline
 SLOAD & 200 & Storage operation \\ \hline
 SSTORE & 5.000 / 20.000 & Storage operation \\ \hline
 BALANCE & 400 & Get balance of an account \\ \hline
 CREATE & 32.000 & Create a new account using CREATE \\ \hline
 CALL & 25.000 & Create a new account using CALL \\ \hline
 LOG & 375 & Logging operation \\ \hline
\end{tabular}
\caption{Ethereum opcodes gas costs}
\label{table:opcode_gas_cost}
\end{table}

\clearpage

\section{Benchmarks}
\label{evaluation:benchmarks}

\subsection{Data storage}
\label{evaluation:data_storage}

The first evaluation test calculates the cost of storing raw data on the blockchain of the following sizes: 32 bytes, 1KB, 1MB, 10MB, 100MB and 1GB. The results are being shown on Table~\ref{table:bytes_usd_cost}. It is worth mentioning that storing 1GB of data on Ethereum costs around \$13.000.000 make it impossible and unpractical to store big data on blockchain technologies.

A common way of countermeasure the preceding problem is to store the data on an off-chain infrastructure (i.e IPFS~\cite{ipfs}, Storj~\cite{storj} or Filecoin~\cite{filecoin}) and store the hash pointer of the data on the blockchain. Storing a fixed size hash is much cheaper than saving the whole data.

Ethereum offers a logging mechanism that can be taken advantage of for data storing. A LOG opcode costs 375 gas and for each byte of data it costs 8 gas, way lower than SSTORE opcode.

Tables~\ref{table:data_store_comparison_01} to~\ref{table:data_store_comparison_05} demonstrate the difference between the four possible ways of storing data for various data sizes: store raw data, store the hash pointer of the data, log raw data and log the has pointer of the data.

\begin{table}[!htb]
\centering
\begin{tabular}{|l|l|l|}
\hline
 Size & Gas  & USD \\ \hline
 32 bytes & 20.000  & \$0.037 \\ \hline
 1KB & 724.664  & \$1.357 \\ \hline
 1MB & 697.325.562  & \$1,305.393 \\ \hline
 10MB & 7.000.000.000  & \$13,104 \\ \hline
 100MB & 70.000.000.000  & \$131,040 \\ \hline
 1GB & 700.000.000.000  & \$13,104,000 \\ \hline
\end{tabular}
\captionsetup{format=hang, justification=centering}
\caption{Saving data costs.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei}
\label{table:bytes_usd_cost}
\end{table}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \begin{axis}[xlabel=Gas,ylabel=Size]
      \addplot[
        color=red,
        mark=x
      ] coordinates {
        (0.032, 20000)
        (1, 724664)
        (1e+3, 697325562)
        (1e+4, 7e+10)
        (1e+5, 7e+11)
        (1e+6, 7e+12)
      };
    \end{axis}
  \end{tikzpicture}
  \caption{}
  \label{}
\end{figure}

\begin{table}[!htb]
  \centering
  \begin{tabular}{|l|l|l|l|}
  \hline
  Type & Size & Gas  & USD \\ \hline
  Store raw data & 32 bytes & 34.916  & \$0.065 \\ \hline
  Store hash pointer & 32 bytes & 34.850  & \$0.065 \\ \hline
  Log raw data & 32 bytes & 25.995  & \$0.048 \\ \hline
  Log hash pointer & 32 bytes & 25.995  & \$0.048 \\ \hline
  \end{tabular}
  \captionsetup{format=hang, justification=centering}
  \caption{Comparing methods of storing data.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei - Data Size: 32 bytes}
  \label{table:data_store_comparison_01}
\end{table}

\begin{table}[!htb]
  \centering
  \begin{tabular}{|l|l|l|l|}
  \hline
    Type & Size & Gas  & USD \\ \hline
    Store raw data & 1KB & 724.730  & \$1.347 \\ \hline
    Store hash pointer & 32 bytes & 34.850  & \$0.065 \\ \hline
    Log raw data & 1KB & 104.310  & \$0.194 \\ \hline
    Log hash pointer & 32 bytes & 25.995  & \$0.048 \\ \hline
  \end{tabular}
  \captionsetup{format=hang, justification=centering}
  \caption{Comparing methods of storing data.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei - Data Size: 1KB}
  \label{table:data_store_comparison_02}
\end{table}

\begin{table}[!htb]
  \centering
  \begin{tabular}{|l|l|l|l|}
    \hline
      Type & Size & Gas  & USD \\ \hline
      Store raw data & 10KB & 6.668.509  & \$12.39 \\ \hline
      Store hash pointer & 32 bytes & 34.850  & \$0.065 \\ \hline
      Log raw data & 10KB & 832.604  & \$1.547 \\ \hline
      Log hash pointer & 32 bytes & 25.995  & \$0.048 \\ \hline
  \end{tabular}
  \captionsetup{format=hang, justification=centering}
  \caption{Comparing methods of storing data.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei - Data Size: 10KB}
  \label{table:data_store_comparison_03}
\end{table}

\begin{table}[!htb]
  \centering
  \begin{tabular}{|l|l|l|l|}
    \hline
    Type & Size & Gas  & USD \\ \hline
    Store raw data & 100KB & 66.454.178  & \$123.472 \\ \hline
    Store hash pointer & 32 bytes & 34.850  & \$0.065 \\ \hline
    Log raw data & 100KB & 8.186.883  & \$15.211 \\ \hline
    Log hash pointer & 32 bytes & 25.995  & \$0.048 \\ \hline
  \end{tabular}
  \captionsetup{format=hang, justification=centering}
  \caption{Comparing methods of storing data.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei - Data Size: 100KB}
  \label{table:data_store_comparison_04}
\end{table}

\begin{table}[!htb]
  \centering
  \begin{tabular}{|l|l|l|l|}
    \hline
    Type & Size & Gas  & USD \\ \hline
    Store raw data & 1MB & 666.092.228  & \$1,237.599 \\ \hline
    Store hash pointer & 32 bytes & 34.850  & \$0.065 \\ \hline
    Log raw data & 1MB & 88.857.033  & \$165.096 \\ \hline
    Log hash pointer & 32 bytes & 25.995  & \$0.048 \\ \hline
  \end{tabular}
  \captionsetup{format=hang, justification=centering}
  \caption{Comparing methods of storing data.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei - Data Size: 1MB}
  \label{table:data_store_comparison_05}
\end{table}

\begin{figure}
  \begin{subfigure}[t]{0.475\textwidth}
        \centering
        \begin{tikzpicture}
          \begin{axis}[bar]
            \addplot coordinates {
            (Store raw data,34916)
            (Store hash pointer,34850)
            (Log raw data,25995)
            (Log hash pointer, 25995)
            };
            \legend{Type}
          \end{axis}
        \end{tikzpicture}
        \caption{Size: 32 bytes}
    \end{subfigure}
    \begin{subfigure}[t]{0.475\textwidth}
        \centering
        \begin{tikzpicture}
          \begin{axis}[bar]
            \addplot coordinates {
              (Store raw data,724730)
              (Store hash pointer,34850)
              (Log raw data,104310)
              (Log hash pointer, 25995)
            };
            \legend{Type}
          \end{axis}
        \end{tikzpicture}
        \caption{Size: 1KB}
    \end{subfigure}
    \begin{subfigure}[t]{0.475\textwidth}
        \centering
        \begin{tikzpicture}
          \begin{axis}[bar]
            \addplot coordinates {
              (Store raw data,6668509)
              (Store hash pointer,34850)
              (Log raw data,832604)
              (Log hash pointer, 25995)
            };
            \legend{Type}
          \end{axis}
        \end{tikzpicture}
        \caption{Size: 10KB}
    \end{subfigure}
    \begin{subfigure}[t]{0.475\textwidth}
        \centering
        \begin{tikzpicture}
          \begin{axis}[bar]
            \addplot coordinates {
              (Store raw data,66454178)
              (Store hash pointer,34850)
              (Log raw data,8186883)
              (Log hash pointer, 25995)
            };
            \legend{Type}
          \end{axis}
        \end{tikzpicture}
        \caption{Size: 100KB}
    \end{subfigure}
  \caption{Charts}
  \label{Storage methods}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \begin{axis}[bar]
      \addplot coordinates {
        (Store raw data,666092228)
        (Store hash pointer,34850)
        (Log raw data,88857033)
        (Log hash pointer, 25995)
      };
      \legend{Type}
    \end{axis}
  \end{tikzpicture}
  \caption{Size: 1MB}
  \label{}
\end{figure}

\clearpage

\subsection{Application costs}
\label{evaluation:app_costs}

Table~\ref{table:app_costs} shows the costs of each operation of the application.

\begin{table}[!htb]
\centering
\begin{tabular}{|l|l|l|l|}
\hline
 Type & Gas & ETH & USD \\ \hline
 App deployment & 3.004.253 & 0.00601 & \$5.66 \\ \hline
 Register data set & 233.487 & 0.000467 & \$0.44 \\ \hline
 Request for processing & 89.206 & 0.0001784 & \$0.15 \\ \hline
 Register processor & 83.274 & 0.0001665 & \$0.15 \\ \hline
 Notify processor & 25.279 & 0.00005 & \$0.04 \\ \hline
\end{tabular}
\captionsetup{format=hang, justification=centering}
\caption{Application Costs.\\ ETH Price: \$942.99 (Feb 18, 2018) - Gas Price: 2 Gwei}
\label{table:app_costs}
\end{table}

\subsection{Zero Knowledge Proofs}
\label{evaluation:zkp}

Tables~\ref{table:zkp_01} to~\ref{table:zkp_03} provide details of ZKP performance for each query of the application that the data processor executes. The setup step consists of the compilation of a \verb|C| programm to QAP (ยง~\ref{zkp:snarks}) and the key generation. The compute step consists of circuit evaluation, polynomial solving and proof generation. Lastly, the verification step consists of the verification of the proof.

\begin{table}[!htb]
\centering
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline
 & Setup (s) & Compute (s) & Verify (ms) & Eval Key (MB) & Ver Key (KB) & Proof (B)  \\ \hline
 Sum & 10 & 8 & 28 & 0.016 & 100 & 304 \\ \hline
 Count & 16 & 8 & 26 & 0.005 & 100 & 304 \\ \hline
 Max & 17 & 9 & 28 & 1.7 & 100 & 304 \\ \hline
 Median & 65 & 30 & 28 & 64 & 100 & 304 \\ \hline
 Min & 17 & 9 & 51 & 1.7 & 100 & 304 \\ \hline
 Mean & 16 & 8 & 19 & 0.054 & 100 & 304 \\ \hline
\end{tabular}
\captionsetup{format=hang, justification=centering}
\caption{ZKP Performance: 100 values}
\label{table:zkp_01}
\end{table}

\begin{table}[!htb]
\centering
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline
 & Setup (s) & Compute (s) & Verify (ms) & Eval Key (MB) & Ver Key (KB) & Proof (B)  \\ \hline
 Sum & 10 & 8 & 27 & 0.144 & 100 & 304 \\ \hline
 Count & 15 & 9 & 37 & 0.036 & 100 & 304 \\ \hline
 Max & 29 & 14 & 34 & 17 & 100 & 304 \\ \hline
 Min & 28 & 14 & 49 & 17 & 100 & 304 \\ \hline
 Mean & 17 & 8 & 41 & 182 & 100 & 304 \\ \hline
 Median & 1701 & - & 12 & 64 & 100 & 304 \\ \hline
\end{tabular}
\captionsetup{format=hang, justification=centering}
\caption{ZKP Performance: 1.000 values}
\label{table:zkp_02}
\end{table}

\begin{table}[!htb]
\centering
\begin{tabular}{|l|l|l|l|l|l|l|}
\hline
 & Setup (s) & Compute (s) & Verify (ms) & Eval Key (MB) & Ver Key (KB) & Proof (B)  \\ \hline
 Sum & 10 & 8 & 21 & 1.44 & 100 & 304 \\ \hline
 Count & 17 & 8 & 32 & 0.335 & 100 & 304 \\ \hline
 Max & 130 & 67 & 28 & 171 & 100 & 304 \\ \hline
 Min & 126 & 67 & 27 & 171 & 100 & 304 \\ \hline
 Mean & 22 & 9 & 27 & 1.5 & 100 & 304 \\ \hline
 Median & - & - & - & - & - & - \\ \hline
\end{tabular}
\captionsetup{format=hang, justification=centering}
\caption{ZKP Performance: 10.000 values}
\label{table:zkp_03}
\end{table}
