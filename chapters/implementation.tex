%!TEX root = ../thesis.tex

\tikzstyle{database} = [cylinder, shape border rotate=90, aspect=0.5, draw, fill=green!30],
\tikzstyle{node} = [rectangle, minimum width=4cm, minimum height=1cm, text centered, draw=black, draw, fill=blue!30],
\tikzstyle{blockchain} = [draw,rectangle,minimum width=\textwidth, minimum height=1cm,anchor=west, fill=orange!30],
\tikzstyle{process} = [fill=red!30],
\tikzstyle{txt} = [],
\tikzstyle{entity} = [draw, minimum height=1cm, minimum width=4cm, fill=blue!30]
\tikzstyle{com} = [<->]
\tikzstyle{block} = [draw,thick,inner sep=10pt]
\tikzset{barstyle/.style 2 args={
      draw,
      minimum height=3em,
      fill=orange!30,
      fit={(#1.west) (#1.east)}, inner sep=0pt, label={center:#2}
    }
}

\chapter{Implementation}
\label{implemenation}

As mention at §~\ref{solution} the Blockchain act as the controller of the network. As a result, the application is separated in two parts. The off-chain network and the Blockchain network. The dataset storage, transmission and processing lives off-chain while dataset registration, requests for processing, processing outputs and Zero Knowledge proofs leave on the Blockchain. Every node on the network---a data share node--- is connected to the Blockchain and track every transaction specified for the application. That way it can track and index every registered dataset, request for processing and processing outputs and proofs and act accordingly.

\section{RESTful API}
\label{implemenation:rest}

A RESTful API is provided to facilitate communication between any application, that follows the REST architecture, and the data sharing Blockchain ecosystem. The REST API expose the blockchain business network that can be easily consumed by HTTP or REST clients. That way, any developer familiar with existing web technologies and frameworks is not obligated to learn the interval mechanisms of a Blockchain system to develop and deploy applications atop.

Through the REST API one can:

\begin{itemize}
  \item Get all datasets
  \item Register a dataset
  \item Get a specific dataset
  \item Get all processing requests
  \item Register a request for processing
  \item Get a specific request
  \item Get all processors
  \item Register a processor
  \item Get all Blockchain accounts
\end{itemize}

The REST API expose a set of routes each one having an HTTP method and a URI. All available routes are shown at Table~\ref{table:api_routes}.

\begin{table}[ht!]
\centering
\begin{tabular}{|l|l|}
\hline
 Method & URI  \\ \hline
 GET & /\  \\ \hline
 GET &  /contracts \\ \hline
 GET &  /datastore \\ \hline
 GET &  /datastore/\{data\} \\ \hline
 POST &  /datastore\\ \hline
 GET &  /accounts \\ \hline
 GET &  /accounts/\{account\} \\ \hline
 GET &  /requests \\ \hline
 GET &  /requests/\{request\} \\ \hline
 POST &  /requests \\ \hline
 GET &  /processors \\ \hline
 POST &  /processors \\ \hline
\end{tabular}
\caption{RESTful API Routes}
\label{table:api_routes}
\end{table}

\section{Distributed Application}
\label{implemenation:dapp}

The distributed application is a web-based application providing a graphical user interface (UI) to facilitate the data sharing platform usage. The goal of the distributed application is to provide to the end-user an easy, self-explanatory and efficient way of interacting with the data sharing ecosystem. As most users are already familiar with the use of web applications and platforms, such as webmails, cloud services and social media, such interfaces makes the user feel accustomed. The user does not and should not need to know that interacts with a Blockchain icosystem.

The distributed application consumes the REST API and yields the same functionalities.

\section{Controller}
\label{implemenation:controller}

The controller is a data sharing node that is connected to the Blockchain and listens for processing requests. See §~\ref{solution:entities:data_controller} and §~\ref{solution:flow:pr_req} for more information.

\section{Processor}
\label{implemenation:processor}

The controller is a data sharing node that is connected to the Blockchain and listens for processing notifications by a controller node.  See §~\ref{solution:entities:data_processor} and §~\ref{solution:flow:pr_data} for more information.

\section{Libraries}
\label{implemenation:libs}

\subsection{Blockchain}
\label{implemenation:libs:bl}

The Blockchain library offers a set of functionalities that makes communication with any Blockchain easier. Is a wrapper library over Blockchain specific libraries, such as Ethereum's \verb|web3|, and it's main purpose is to be Blockchain agnostic allowing the use of different Blockchains. For the moment only the Ethereum Blockchain is supported.

\subsection{Crypto}
\label{implemenation:libs:cr}

The crypto library provides cryptographic functionality that includes a set of wrappers for \verb|SJCL| and \verb|Node.js Crypto module| functions.

Specifically:

\begin{enumerate}
  \item Asymmetric encryption key generation
  \item Symmetric encryption key generation
  \item HMAC key generation
  \item Symmetric file encryption
  \item SHA256 hash function
\end{enumerate}

\section{Command-line interface}
\label{implemenation:cli}

A Command-line interface that provides a set of useful commands for the data sharing application.

Usage:

\begin{verbatim}
  $ node data-cli <options>
\end{verbatim}

Options:

\begin{itemize}
  \item \verb|-v| or \verb|--version|: Output the version number
  \item \verb|-g| or \verb|--generate-keys|: Generate an asymmetric
  \item \verb|-k| or \verb|--generate-key|: Generate a symmetric key
  \item \verb|-d| or \verb|--dummy-file <file>|: Generate a 45MB dummy file
  \item \verb|-e| or \verb|--encrypt-file <file>|: Encrypt a file
  \item \verb|-a| or \verb|--evaluation <bytes>|: Evaluate gas cost of bytes on Ethereum
  \item \verb|-s| or \verb|--hash <hash>|: Hash with SHA256 an array of arguments
  \item \verb|-f| or \verb|--hash-file <file>|: Hash with SHA256 a file
  \item \verb|-h| or \verb|--help|: Output usage information
\end{itemize}

\section{Smart contracts}

\begin{figure}[ht!]
  \center
  \begin{tikzpicture}
    \begin{scope}[node distance=2cm]
      \node[entity] (api) {API};
      \node[entity] (dapp) [above=of api] {Dapp};
      \node[entity] (eth_node) [below=of api] {Ethereum node};
      \node[database] (db) [right=of api, yshift=-0.3cm] {Mongodb};
    \end{scope}

    \draw[com] (api) -- (eth_node);
    \draw[com] (api) -- (dapp);
    \draw[com] (api.east) ++ (right:0ex) -- ++ (right:2cm);

    \node[block,fit=(dapp) (eth_node) (db), label={Local Enviroment}] (local) {};

    \node[barstyle={local}{Ethereum Blockchain}, below=of local] (blockchain) {};

    \draw[com] (eth_node.south) ++ (south:0ex) -- ++ (south:1.35cm);

    \begin{scope}[node distance=2cm]
      \node[entity] (eth_node_pr) [below=of blockchain, xshift=-2cm, yshift=0.65cm] {Ethereum node};
      \node[entity] (processor) [below=of eth_node_pr] {Processor};
      \node[database] (db_pr) [right=of processor, yshift=-0.3cm] {Mongodb};
    \end{scope}

    \draw[com] (eth_node_pr.north) ++ (north:0ex) -- ++ (north:1.35cm);
    \draw[com] (processor) -- (eth_node_pr);
    \draw[com] (processor.east) ++ (right:0ex) -- ++ (right:2cm);

    \node[block,fit=(eth_node_pr) (processor) (db_pr), label={below:Local Enviroment}] (local) {};

  \end{tikzpicture}
  \caption{Implementation}
  \label{fig:implemenation}
\end{figure}
